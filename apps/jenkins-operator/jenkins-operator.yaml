apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: jenkins-operator
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: 'https://raw.githubusercontent.com/jenkinsci/kubernetes-operator/master/chart'
    targetRevision: 0.6.0
    chart: jenkins-operator
    helm:
      values: |
        jenkins:
          enabled: true
          # image: jenkins/jenkins:2.319.2-lts-alpine
          env:
          - name: JAVA_OPTS
            value: "-Djenkins.install.runSetupWizard=false -Djava.awt.headless=true -Djava.net.useSystemProxies=true -Dhttp.nonProxyHosts=localhost"
          - name: "JENKINS_URL"
            value: "http://jenkins-operator-http-jenkins.svc.cluster.local:8080"
          - name: "JENKINS_TUNNEL"
            value: "jenkins-operator-slave-jenkins.svc.cluster.local:50000"
          - name: "DEBUG_JENKINS_OPERATOR"
            value: "true"
          # - name: no_proxy
          #   value: "127.0.0.1,localhost,91.123.96.29,10.233.0.0/16,10.234.0.0/16,.svc,.svc.cluster.local"
          - name: manos
            value: "test"
          namespace: jenkins-operator
          # serviceAccount: jenkins-service-account
          backup:
            pvc:
              className: "ceph-rbd"
          basePlugins:
          - name: kubernetes
            version: "1.31.2"
          - name: workflow-job
            version: "1145.v7f2433caa07f"
          - name: workflow-aggregator
            version: "2.6"
          - name: git
            version: "4.10.0"
          - name: job-dsl
            version: "1.78.1"
          - name: configuration-as-code
            version: "1.55"
          - name: kubernetes-credentials-provider
            version: "0.20"
      parameters:
        - name: installCRDs
          value: "false"
        - name: serviceAccountName
          value: "jenkins-operator"
      # parameters: |
      #   # - name: installCRDs
      #   #   value: 'false'
      #   #- name: extraArgs[0]
      #   #  value: '--dns01-recursive-nameservers=coredns.kube-system.svc.cluster.local:53'
      #   #- name: extraArgs[1]
      #   #  value: '--dns01-recursive-nameservers-only'
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: jenkins-operator
  syncPolicy:
    automated: # automated sync by default retries failed attempts 5 times with following delays between attempts ( 5s, 10s, 20s, 40s, 80s ); retry controlled using `retry` field.
      prune: true # Specifies if resources should be pruned during auto-syncing ( false by default ).
      selfHeal: true # Specifies if partial app sync should be executed when resources are changed only in target Kubernetes cluster and no git change detected ( false by default ).
      allowEmpty: false # Allows deleting all application resources during automatic syncing ( false by default ).
    syncOptions:     # Sync options which modifies sync behavior
      - Validate=false # disables resource validation (equivalent to 'kubectl apply --validate=false') ( true by default ).
      - CreateNamespace=true # Namespace Auto-Creation ensures that namespace specified as the application destination exists in the destination cluster.
      - PrunePropagationPolicy=foreground # Supported policies are background, foreground and orphan.
      - PruneLast=true # Allow the ability for resource pruning to happen as a final, implicit wave of a sync operation
    # The retry feature is available since v1.7
    retry:
      limit: 5 # number of failed sync attempt retries; unlimited number of attempts if less than 0
      backoff:
        duration: 5s # the amount to back off. Default unit is seconds, but could also be a duration (e.g. "2m", "1h")
        factor: 2 # a factor to multiply the base duration after each failed retry
        maxDuration: 3m # the maximum amount of time allowed for the backoff strategy
